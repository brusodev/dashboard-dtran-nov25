<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DTRAN - COGESPA | Novembro 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { @apply bg-white rounded-lg shadow-md p-6 border border-gray-100; }
        .card-header { @apply text-gray-500 text-sm font-medium uppercase mb-2; }
        .card-value { @apply text-3xl font-bold text-gray-800; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 flex items-center gap-2; }
        .btn-outline { @apply bg-transparent hover:bg-blue-50 text-blue-600 font-semibold py-2 px-4 border border-blue-600 rounded transition duration-200 flex items-center gap-2; }
        
        /* Custom Scrollbar for Table */
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* ===== ESTILOS DE IMPRESSÃO ===== */
        @media print {
            /* Reset básico para impressão */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background-color: white !important;
                margin: 0;
                padding: 0;
            }
            
            /* Ocultar elementos não necessários na impressão */
            nav, .btn-primary, .btn-outline, button, input, .print-button {
                display: none !important;
            }
            
            /* Container principal - layout compacto */
            main {
                max-width: 100% !important;
                padding: 8mm 12mm !important;
                margin: 0 !important;
            }
            
            /* Ajustes de página */
            @page {
                size: A4 portrait;
                margin: 10mm 8mm;
            }
            
            /* Cabeçalho da impressão - mais compacto */
            main::before {
                content: "DTRAN-COGESPA - Dashboard Operacional Novembro 2025";
                display: block;
                font-size: 16px;
                font-weight: bold;
                text-align: center;
                margin-bottom: 6px;
                padding-bottom: 5px;
                border-bottom: 2px solid #3b82f6;
            }
            
            /* Rodapé com data */
            main::after {
                content: "Gerado em: " attr(data-print-date) " | DTRAN-COGESPA - Coordenação de Gestão de Patrimônio";
                display: block;
                position: fixed;
                bottom: 3mm;
                left: 12mm;
                right: 12mm;
                text-align: center;
                font-size: 8px;
                color: #666;
                padding-top: 4px;
                border-top: 1px solid #ccc;
            }
            
            /* Remover títulos redundantes */
            main > div:first-child {
                display: none !important;
            }
            
            /* KPI Cards - 2x2 grid para retrato */
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 5px !important;
                margin-bottom: 6px !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .border-l-4 {
                border-width: 2px !important;
                box-shadow: none !important;
                padding: 6px 8px !important;
                page-break-inside: avoid;
                min-height: 60px !important;
            }
            
            .border-l-4 .flex {
                gap: 6px !important;
            }
            
            .border-l-4 p {
                font-size: 8px !important;
                margin-bottom: 2px !important;
            }
            
            .border-l-4 h2 {
                font-size: 18px !important;
                margin-top: 2px !important;
            }
            
            .border-l-4 .p-3 {
                padding: 5px !important;
                width: 28px !important;
                height: 28px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            /* Seção de gráficos - 2 colunas para retrato */
            .grid.grid-cols-1.lg\\:grid-cols-3 {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
                margin-bottom: 6px !important;
                page-break-inside: avoid;
            }
            
            /* Cards de gráficos - compactos */
            .bg-white.rounded-lg.shadow {
                padding: 6px !important;
                page-break-inside: avoid;
                height: auto !important;
                min-height: 0 !important;
            }
            
            .bg-white.rounded-lg.shadow h3 {
                font-size: 10px !important;
                margin-bottom: 4px !important;
                font-weight: 600 !important;
            }
            
            /* Gráficos - tamanho reduzido para retrato */
            .h-64 {
                height: 130px !important;
                max-height: 130px !important;
                width: 100% !important;
            }
            
            canvas {
                height: 130px !important;
                max-height: 130px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Container dos gráficos de pizza/donut - centralizado */
            .flex.justify-center {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                height: 130px !important;
                max-height: 130px !important;
            }
            
            .flex.justify-center canvas {
                max-width: 150px !important;
                width: auto !important;
                height: 130px !important;
            }
            
            /* Grid específico: fazer 3 colunas onde estão os charts grandes */
            .lg\\:col-span-2 {
                grid-column: span 1 / span 1 !important;
            }
            
            /* Tabela - ultra compacta */
            .bg-white.rounded-lg.shadow.overflow-hidden {
                margin-top: 6px !important;
                page-break-inside: avoid;
            }
            
            .bg-white.rounded-lg.shadow.overflow-hidden .px-6 {
                padding: 5px 8px !important;
            }
            
            .bg-white.rounded-lg.shadow.overflow-hidden h3 {
                font-size: 10px !important;
            }
            
            table {
                font-size: 7px !important;
                line-height: 1.2 !important;
            }
            
            th {
                background-color: #f3f4f6 !important;
                padding: 3px 4px !important;
                font-size: 7px !important;
            }
            
            td {
                padding: 3px 4px !important;
            }
            
            thead {
                display: table-header-group;
            }
            
            /* Cores dos cards mantidas */
            .border-blue-500 { border-color: #3b82f6 !important; }
            .border-purple-500 { border-color: #a855f7 !important; }
            .border-orange-500 { border-color: #f97316 !important; }
            .border-green-500 { border-color: #22c55e !important; }
            
            .bg-blue-100 { background-color: #dbeafe !important; }
            .bg-purple-100 { background-color: #f3e8ff !important; }
            .bg-orange-100 { background-color: #ffedd5 !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
            
            .text-blue-600 { color: #2563eb !important; }
            .text-purple-600 { color: #9333ea !important; }
            .text-orange-600 { color: #ea580c !important; }
            .text-green-600 { color: #16a34a !important; }
            
            /* Remover sombras */
            .shadow, .shadow-sm, .shadow-md, .shadow-lg {
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
            }
            /* Margens e espaçamentos globais reduzidos */
            .mb-8, .mb-6 {
                margin-bottom: 6px !important;
            }
            
            .gap-6 {
                gap: 5px !important;
            }
            
            .p-6 {
                padding: 6px !important;
            }   padding: 8px !important;
            }
            
            .py-4 {
                padding-top: 4px !important;
                padding-bottom: 4px !important;
            }
            
            .px-6 {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            .py-3 {
                padding-top: 3px !important;
                padding-bottom: 3px !important;
            }
            /* Ícones menores */
            .fa-solid, .fa-regular {
                font-size: 12px !important;
            }
            
            /* Texto do rodapé menor */
            main::after {
                font-size: 7px !important;
            }   font-size: 14px !important;
            }
            
            /* Garantir que tudo caiba em uma página */
            .overflow-hidden, .overflow-x-auto {
                overflow: visible !important;
            }
            
            /* Texto descritivo dos KPIs menor */
            .text-xs.text-gray-400 {
                font-size: 7px !important;
                margin-top: 2px !important;
            }
            
            /* Ajustar border radius */
            .rounded-lg, .rounded-full {
                border-radius: 4px !important;
            }
            
            /* Forçar tudo em uma única página */
            main > * {
                page-break-inside: avoid;
            }
        }
        
        /* Botão de impressão - visível apenas na tela */
        @media screen {
            .print-button {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
        }
    </style>
</head>
<body>

    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-car text-blue-600 text-2xl"></i>
                    <span class="font-bold text-xl text-gray-800">DTRAN - COGESPA</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="printDashboard()" class="btn-outline text-sm">
                        <i class="fa-solid fa-print"></i> Imprimir
                    </button>
                    <button onclick="downloadTemplate()" class="btn-outline text-sm">
                        <i class="fa-solid fa-download"></i> Baixar Modelo JSON
                    </button>
                    <label class="btn-primary cursor-pointer text-sm">
                        <i class="fa-solid fa-upload"></i> Importar Dados
                        <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Info -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Gestão Operacional - Novembro 2025</h1>
            <p class="text-gray-500 mt-1">Coordenação de Gestão de Transportes - Análise de Processos e Atendimentos</p>
        </div>

        <!-- KPI Cards Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Processos -->
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Total de Atendimentos</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-2" id="kpi-total">0</h2>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                        <i class="fa-solid fa-file-alt"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">INCLUSO TODOS OS PROCESSOS DO MÊS</p>
            </div>

            <!-- Serviços de Tráfego -->
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Pedidos de tráfego atendidos</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-2" id="kpi-trafego">0</h2>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-full text-purple-600">
                        <i class="fa-solid fa-truck"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2" id="kpi-trafego-detail">Frota interna + terceirizada</p>
            </div>

            <!-- Multas -->
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-orange-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Multas/Notificações</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-2" id="kpi-multas">0</h2>
                    </div>
                    <div class="p-3 bg-orange-100 rounded-full text-orange-600">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2" id="kpi-multas-detail">Diretorias envolvidas</p>
            </div>

             <!-- Veículos Licenciados -->
             <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Veículos Licenciados</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-2" id="kpi-licenciados">0</h2>
                    </div>
                    <div class="p-3 bg-green-100 rounded-full text-green-600">
                        <i class="fa-solid fa-id-card"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2" id="kpi-licenciados-detail">Prefeituras + APAEs</p>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Main Volume Chart -->
            <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Serviços de Tráfego por Setor - Novembro 2025</h3>
                <div class="h-64">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Tipo de Processo -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Distribuição de Processos</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="tipoProcessoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
             <!-- Multas por Diretoria -->
             <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Quantidades de Multas</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="frotaChart"></canvas>
                </div>
            </div>

            <!-- Dados Novembro -->
            <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Indicadores dos Princ. Atendimentos de Nov/2025</h3>
                <div class="h-64">
                    <canvas id="opsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800">Detalhamento dos Dados</h3>
            </div>
            <div class="overflow-x-auto table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atividades</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processos (Novembro)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipe Responsável</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dataTableBody">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Botão Flutuante de Impressão -->
    <button onclick="printDashboard()" class="print-button btn-primary fixed bottom-8 right-8 shadow-lg hover:shadow-xl">
        <i class="fa-solid fa-print"></i> Imprimir Relatório
    </button>

    <!-- JavaScript Logic -->
    <script>
        // --- 1. Dados Reais DTRAN-COGESPA (Novembro 2025) - Extraídos das Planilhas ---
        const initialData = {
            "periodo": "Novembro 2025",
            "orgao": "DTRAN - Coordenação de Gestão de Patrimônio (COGESPA)",
            "trafego_terceirizado": {
                "total_pedidos": 287,
                "setores_atendidos": 14,
                "dias_pernoite": 24,
                "todos_setores": {
                    "SUPED": 68,
                    "EFAPE": 41,
                    "SEDUC": 38,
                    "DIPES": 25,
                    "SUBSEC": 24,
                    "DIISE": 23,
                    "GABINETE": 21,
                    "COGESPA": 18,
                    "SUART": 10,
                    "SUPLAN": 8,
                    "CEAE": 4,
                    "DIORF": 3,
                    "AIMPRES": 3,
                    "SUCOR": 1
                },
                "top_setores": {
                    "SUPED": 68,
                    "EFAPE": 41,
                    "SEDUC": 38,
                    "DIPES": 25,
                    "SUBSEC": 24
                }
            },
            "trafego_interno": {
                "total_atendimentos": 14,
                "departamentos_atendidos": 6,
                "veiculos_utilizados": {
                    "MICROONIBUS": 6,
                    "VAN SEM BANCO": 4,
                    "VAN": 4
                },
                "top_departamentos": {
                    "DZEL": 3,
                    "EFAPE": 3,
                    "SUPED": 3,
                    "DIPES": 2,
                    "GABINETE": 2
                }
            },
            "multas": {
                "total": 87,
                "diretorias_envolvidas": 39,
                "veiculos_multados": 71,
                "top_diretorias": {
                    "JAU": 8,
                    "PRESIDENTE PRUDENTE": 6,
                    "JABOTICABAL": 6,
                    "JALES": 5,
                    "SANTO ANASTACIO": 4
                },
                "recursos_deferidos": 13,
                "recursos_indeferidos": 33,
                "pagamentos": 40
            },
            "licenciamento": {
                "prefeituras": {
                    "diretorias": 62,
                    "entidades": 280,
                    "veiculos": 375
                },
                "apaes": {
                    "diretorias": 29,
                    "entidades": 40,
                    "veiculos": 40
                },
                "total_veiculos": 415,
                "total_entidades": 320,
                "total_diretorias": 91
            },
            "kpis": {
                "total_processos": 803,
                "servicos_trafego": 301,
                "multas_notificacoes": 87,
                "veiculos_licenciados": 415
            },
            "dados_novembro": {
                "mes": "Novembro/2025",
                "trafego": 301,
                "multas": 87,
                "licenciamento": 415
            }
        };

        // Variáveis globais para os gráficos
        let volumeChartInst, tipoProcessoChartInst, frotaChartInst, opsChartInst;

        // --- 2. Função de Inicialização ---
        window.onload = function() {
            // Registrar plugin globalmente
            Chart.register(ChartDataLabels);
            
            // Configurar defaults do plugin
            Chart.defaults.set('plugins.datalabels', {
                color: '#fff',
                font: {
                    weight: 'bold',
                    size: 11
                },
                padding: 4,
                formatter: (value) => value.toLocaleString('pt-BR')
            });

            renderDashboard(initialData);
        };

        // --- 3. Lógica de Renderização ---
        function renderDashboard(data) {
            updateKPIs(data);
            renderCharts(data);
            renderTable(data);
        }

        function updateKPIs(data) {
            document.getElementById('kpi-total').innerText = data.kpis.total_processos.toLocaleString('pt-BR');
            document.getElementById('kpi-trafego').innerText = data.kpis.servicos_trafego;
            document.getElementById('kpi-trafego-detail').innerText = `${data.trafego_terceirizado.total_pedidos} terceirizada | ${data.trafego_interno.total_atendimentos} interna`;
            document.getElementById('kpi-multas').innerText = data.multas.total;
            document.getElementById('kpi-multas-detail').innerText = `${data.multas.diretorias_envolvidas} diretorias | ${data.multas.veiculos_multados} veículos`;
            document.getElementById('kpi-licenciados').innerText = data.licenciamento.total_veiculos;
            document.getElementById('kpi-licenciados-detail').innerText = `${data.licenciamento.prefeituras.veiculos} prefeituras | ${data.licenciamento.apaes.veiculos} APAEs`;
        }

        function renderCharts(data) {
            // Configurações comuns
            const commonOptions = { 
                responsive: true, 
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 20, right: 30, left: 10, bottom: 10 }
                }
            };

            // 1. Chart: Serviços de Tráfego por Setor (Todos os 14 setores)
            const ctxVolume = document.getElementById('volumeChart').getContext('2d');
            if(volumeChartInst) volumeChartInst.destroy();
            
            const todosSetores = Object.entries(data.trafego_terceirizado.todos_setores)
                .sort((a, b) => b[1] - a[1]); // Ordenar decrescente
            
            volumeChartInst = new Chart(ctxVolume, {
                type: 'bar',
                data: {
                    labels: todosSetores.map(([setor, _]) => setor),
                    datasets: [{
                        label: 'Pedidos Atendidos (Frota Terceirizada)',
                        data: todosSetores.map(([_, qtd]) => qtd),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        datalabels: {
                            align: 'end',
                            anchor: 'end',
                            color: '#333',
                            offset: 4
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    indexAxis: 'y',
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            max: Math.max(...todosSetores.map(([_, qtd]) => qtd)) * 1.15
                        }
                    }
                }
            });

            // 2. Chart: Distribuição de Processos (Pie)
            const ctxTipo = document.getElementById('tipoProcessoChart').getContext('2d');
            if(tipoProcessoChartInst) tipoProcessoChartInst.destroy();

            tipoProcessoChartInst = new Chart(ctxTipo, {
                type: 'doughnut',
                data: {
                    labels: ['Veíc. Licenciados', 'Serviços de Tráfego', 'Multas/Notificações'],
                    datasets: [{
                        data: [
                            data.licenciamento.total_veiculos,
                            data.kpis.servicos_trafego,
                            data.multas.total
                        ],
                        backgroundColor: [
                            '#10b981',
                            '#3b82f6',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 10 },
                            formatter: function(value, context) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage + '%';
                            }
                        }
                    }
                }
            });

            // 3. Chart: Distribuição de Multas por Quantidade
            const ctxFrota = document.getElementById('frotaChart').getContext('2d');
            if(frotaChartInst) frotaChartInst.destroy();

            // Ordenar em ordem decrescente
            const multasData = [
                { label: 'Total de Multas', value: data.multas.total, color: 'rgba(239, 68, 68, 0.8)', borderColor: 'rgb(239, 68, 68)' },
                { label: 'Pagamentos', value: data.multas.pagamentos, color: 'rgba(59, 130, 246, 0.8)', borderColor: 'rgb(59, 130, 246)' },
                { label: 'Recursos Indeferidos', value: data.multas.recursos_indeferidos, color: 'rgba(245, 158, 11, 0.8)', borderColor: 'rgb(245, 158, 11)' },
                { label: 'Recursos Deferidos', value: data.multas.recursos_deferidos, color: 'rgba(16, 185, 129, 0.8)', borderColor: 'rgb(16, 185, 129)' }
            ].sort((a, b) => b.value - a.value);

            frotaChartInst = new Chart(ctxFrota, {
                type: 'bar',
                data: {
                    labels: multasData.map(item => item.label),
                    datasets: [{
                        label: 'Quantidade',
                        data: multasData.map(item => item.value),
                        backgroundColor: multasData.map(item => item.color),
                        borderColor: multasData.map(item => item.borderColor),
                        borderWidth: 2,
                        datalabels: {
                            align: 'end',
                            anchor: 'end',
                            color: '#333',
                            font: { weight: 'bold', size: 13 },
                            offset: 4
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            max: data.multas.total * 1.15
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 4. Chart: Indicadores de Novembro
            const ctxOps = document.getElementById('opsChart').getContext('2d');
            if(opsChartInst) opsChartInst.destroy();

            // Ordenar em ordem decrescente
            const indicadoresData = [
                { label: 'Veículos Licenciados', value: data.dados_novembro.licenciamento, color: 'rgba(16, 185, 129, 0.8)', borderColor: 'rgb(16, 185, 129)' },
                { label: 'Serviços de Tráfego', value: data.dados_novembro.trafego, color: 'rgba(59, 130, 246, 0.8)', borderColor: 'rgb(59, 130, 246)' },
                { label: 'Multas/Notificações', value: data.dados_novembro.multas, color: 'rgba(245, 158, 11, 0.8)', borderColor: 'rgb(245, 158, 11)' }
            ].sort((a, b) => b.value - a.value);

            opsChartInst = new Chart(ctxOps, {
                type: 'bar',
                data: {
                    labels: indicadoresData.map(item => item.label),
                    datasets: [
                        {
                            label: 'Novembro/2025',
                            data: indicadoresData.map(item => item.value),
                            backgroundColor: indicadoresData.map(item => item.color),
                            borderColor: indicadoresData.map(item => item.borderColor),
                            borderWidth: 2,
                            datalabels: {
                                align: 'end',
                                anchor: 'end',
                                color: '#333',
                                font: { weight: 'bold', size: 14 },
                                offset: 4
                            }
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            max: Math.max(data.dados_novembro.trafego, data.dados_novembro.licenciamento) * 1.15
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            const items = [
                { 
                    area: "Tráfego - Frota Terceirizada", 
                    processos: data.trafego_terceirizado.total_pedidos, 
                    equipe: "33 Motoristas", 
                    obs: `${data.trafego_terceirizado.setores_atendidos} setores atendidos | ${data.trafego_terceirizado.dias_pernoite} dias em pernoite` 
                },
                { 
                    area: "Tráfego - Frota Interna", 
                    processos: data.trafego_interno.total_atendimentos, 
                    equipe: "2 Servidores", 
                    obs: `${data.trafego_interno.departamentos_atendidos} departamentos | Tipos: MICROÔNIBUS (6), VAN (4), VAN SEM BANCO (4)` 
                },
                { 
                    area: "Multas e Notificações", 
                    processos: data.multas.total, 
                    equipe: "4 Servidores", 
                    obs: `${data.multas.diretorias_envolvidas} diretorias | ${data.multas.veiculos_multados} veículos | Def: ${data.multas.recursos_deferidos}, Indef: ${data.multas.recursos_indeferidos}, Pagos: ${data.multas.pagamentos}` 
                },
                { 
                    area: "Licenciamento - Prefeituras", 
                    processos: data.licenciamento.prefeituras.veiculos, 
                    equipe: "4 Servidores", 
                    obs: `${data.licenciamento.prefeituras.diretorias} diretorias | ${data.licenciamento.prefeituras.entidades} prefeituras` 
                },
                { 
                    area: "Licenciamento - APAEs", 
                    processos: data.licenciamento.apaes.veiculos, 
                    equipe: "4 Servidores", 
                    obs: `${data.licenciamento.apaes.diretorias} diretorias | ${data.licenciamento.apaes.entidades} APAEs` 
                }
            ];

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.area}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.processos.toLocaleString('pt-BR')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.equipe}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.obs}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. Funcionalidades de Arquivo ---

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    // Validação simples
                    if(!jsonData.trafego_terceirizado || !jsonData.multas || !jsonData.licenciamento) {
                        alert("Formato de arquivo inválido! Certifique-se de usar a estrutura correta.");
                        return;
                    }
                    renderDashboard(jsonData);
                    alert("Dashboard atualizado com sucesso!");
                } catch (error) {
                    alert("Erro ao ler o arquivo JSON. Verifique a sintaxe.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function downloadTemplate() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(initialData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "dados_dtran_cogespa_novembro_2025.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- 5. Função de Impressão ---
        function printDashboard() {
            // Adicionar data de impressão
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR') + ' às ' + now.toLocaleTimeString('pt-BR');
            document.querySelector('main').setAttribute('data-print-date', dateStr);
            
            // Aguardar um momento para garantir que os gráficos foram renderizados
            setTimeout(() => {
                window.print();
            }, 500);
        }

    </script>
</body>
</html>